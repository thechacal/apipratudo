openapi: 3.0.3
info:
  title: apipratudo Quota Service
  version: 0.1.0
  description: Servico interno para quotas e rate limit do api-gateway.
servers:
  - url: https://quota.apipratudo.local
paths:
  /v1/api-keys:
    post:
      summary: Criar API key
      description: Endpoint administrativo para criar uma API key.
      tags:
        - api-keys
      security:
        - AdminToken: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ApiKeyCreateRequest"
      responses:
        "201":
          description: API key criada
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiKeyCreateResponse"
        "400":
          description: Erro de validacao
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Token admin invalido
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /v1/api-keys/{id}:
    get:
      summary: Obter API key
      tags:
        - api-keys
      security:
        - AdminToken: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: API key encontrada
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiKeyResponse"
        "401":
          description: Token admin invalido
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: API key nao encontrada
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /v1/api-keys/{id}/rotate:
    post:
      summary: Rotacionar API key
      tags:
        - api-keys
      security:
        - AdminToken: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: API key rotacionada
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiKeyRotateResponse"
        "401":
          description: Token admin invalido
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: API key nao encontrada
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /v1/api-keys/{id}/status:
    patch:
      summary: Atualizar status da API key
      tags:
        - api-keys
      security:
        - AdminToken: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ApiKeyStatusUpdateRequest"
      responses:
        "200":
          description: Status atualizado
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiKeyResponse"
        "400":
          description: Erro de validacao
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Token admin invalido
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: API key nao encontrada
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /v1/quota/consume:
    post:
      summary: Consumir quota
      description: Endpoint interno para debitar quota.
      tags:
        - quota
      security:
        - InternalToken: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/QuotaConsumeRequest"
      responses:
        "200":
          description: Consumo permitido
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/QuotaConsumeResponse"
        "401":
          description: API key invalida
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/QuotaConsumeResponse"
        "429":
          description: Limite excedido
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/QuotaConsumeResponse"
  /v1/quota/refund:
    post:
      summary: Reembolsar quota
      description: Endpoint interno para desfazer consumo.
      tags:
        - quota
      security:
        - InternalToken: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/QuotaRefundRequest"
      responses:
        "200":
          description: Reembolso processado
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/QuotaRefundResponse"
        "401":
          description: API key invalida
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/QuotaRefundResponse"
  /v1/quota/status:
    get:
      summary: Status de quota
      description: Endpoint interno/admin ou via X-Api-Key para ver uso atual.
      tags:
        - quota
      security:
        - AdminToken: []
        - InternalToken: []
        - ApiKeyAuth: []
      parameters:
        - name: apiKey
          in: query
          required: false
          schema:
            type: string
      responses:
        "200":
          description: Status atual
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/QuotaStatusResponse"
        "401":
          description: Token invalido
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: API key nao encontrada
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /v1/internal/keys/create-free:
    post:
      summary: Criar API key FREE
      description: Endpoint interno para o portal solicitar uma chave FREE.
      tags:
        - api-keys
      security:
        - PortalToken: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateFreeKeyRequest"
      responses:
        "201":
          description: API key FREE criada
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CreateFreeKeyResponse"
        "400":
          description: Erro de validacao
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Token portal invalido
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "429":
          description: Limite de criacao de chaves excedido
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /v1/credits/add:
    post:
      summary: Adicionar creditos
      description: Endpoint interno/admin para adicionar creditos a API key.
      tags:
        - credits
      security:
        - AdminToken: []
        - InternalToken: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AddCreditsRequest"
      responses:
        "200":
          description: Creditos adicionados
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AddCreditsResponse"
        "400":
          description: Erro de validacao
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Token invalido
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: API key nao encontrada
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
components:
  securitySchemes:
    AdminToken:
      type: apiKey
      in: header
      name: X-Admin-Token
    InternalToken:
      type: apiKey
      in: header
      name: X-Internal-Token
    PortalToken:
      type: apiKey
      in: header
      name: X-Portal-Token
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-Api-Key
  schemas:
    ErrorResponse:
      type: object
      properties:
        error:
          type: string
        message:
          type: string
        details:
          type: array
          items:
            type: string
    ApiKeyStatus:
      type: string
      enum:
        - ACTIVE
        - SUSPENDED
    Plan:
      type: string
      enum:
        - FREE
        - PREMIUM
    ApiKeyLimits:
      type: object
      required:
        - requestsPerMinute
        - requestsPerDay
      properties:
        requestsPerMinute:
          type: integer
          minimum: 1
        requestsPerDay:
          type: integer
          minimum: 1
    ApiKeyCredits:
      type: object
      required:
        - remaining
      properties:
        remaining:
          type: integer
          format: int64
    ApiKeyCreateRequest:
      type: object
      required:
        - name
        - owner
        - limits
      properties:
        name:
          type: string
        owner:
          type: string
        ownerEmail:
          type: string
          format: email
        orgName:
          type: string
        plan:
          $ref: "#/components/schemas/Plan"
        limits:
          $ref: "#/components/schemas/ApiKeyLimits"
    ApiKeyCreateResponse:
      type: object
      required:
        - id
        - apiKey
        - name
        - owner
        - plan
        - limits
        - createdAt
        - credits
      properties:
        id:
          type: string
        apiKey:
          type: string
        name:
          type: string
        owner:
          type: string
        ownerEmail:
          type: string
          format: email
        orgName:
          type: string
        plan:
          $ref: "#/components/schemas/Plan"
        limits:
          $ref: "#/components/schemas/ApiKeyLimits"
        createdAt:
          type: string
          format: date-time
        credits:
          $ref: "#/components/schemas/ApiKeyCredits"
    ApiKeyResponse:
      type: object
      required:
        - id
        - name
        - owner
        - plan
        - limits
        - createdAt
        - status
        - credits
      properties:
        id:
          type: string
        name:
          type: string
        owner:
          type: string
        ownerEmail:
          type: string
          format: email
        orgName:
          type: string
        plan:
          $ref: "#/components/schemas/Plan"
        limits:
          $ref: "#/components/schemas/ApiKeyLimits"
        createdAt:
          type: string
          format: date-time
        status:
          $ref: "#/components/schemas/ApiKeyStatus"
        credits:
          $ref: "#/components/schemas/ApiKeyCredits"
    ApiKeyRotateResponse:
      type: object
      required:
        - id
        - apiKey
      properties:
        id:
          type: string
        apiKey:
          type: string
    ApiKeyStatusUpdateRequest:
      type: object
      required:
        - status
      properties:
        status:
          $ref: "#/components/schemas/ApiKeyStatus"
    CreateFreeKeyRequest:
      type: object
      required:
        - email
        - org
      properties:
        email:
          type: string
          format: email
        org:
          type: string
        useCase:
          type: string
    CreateFreeKeyResponse:
      type: object
      required:
        - id
        - apiKey
        - ownerEmail
        - orgName
        - plan
        - limits
        - createdAt
        - credits
      properties:
        id:
          type: string
        apiKey:
          type: string
        ownerEmail:
          type: string
          format: email
        orgName:
          type: string
        plan:
          $ref: "#/components/schemas/Plan"
        limits:
          $ref: "#/components/schemas/ApiKeyLimits"
        createdAt:
          type: string
          format: date-time
        credits:
          $ref: "#/components/schemas/ApiKeyCredits"
    AddCreditsRequest:
      type: object
      required:
        - credits
      properties:
        apiKey:
          type: string
        apiKeyHash:
          type: string
        credits:
          type: integer
          format: int64
          minimum: 1
    AddCreditsResponse:
      type: object
      required:
        - apiKeyId
        - creditsAdded
        - creditsRemaining
        - plan
      properties:
        apiKeyId:
          type: string
        creditsAdded:
          type: integer
          format: int64
        creditsRemaining:
          type: integer
          format: int64
        plan:
          $ref: "#/components/schemas/Plan"
    QuotaReason:
      type: string
      enum:
        - INVALID_KEY
        - RATE_LIMITED
        - QUOTA_EXCEEDED
    QuotaConsumeRequest:
      type: object
      required:
        - apiKey
        - requestId
        - route
      properties:
        apiKey:
          type: string
        requestId:
          type: string
        route:
          type: string
        cost:
          type: integer
          default: 1
          minimum: 1
    QuotaConsumeResponse:
      type: object
      required:
        - allowed
      properties:
        allowed:
          type: boolean
        reason:
          $ref: "#/components/schemas/QuotaReason"
        limit:
          type: integer
          format: int64
        remaining:
          type: integer
          format: int64
        resetAt:
          type: string
          format: date-time
        error:
          type: string
        message:
          type: string
        plan:
          $ref: "#/components/schemas/Plan"
        limits:
          $ref: "#/components/schemas/ApiKeyLimits"
        usage:
          $ref: "#/components/schemas/QuotaUsage"
        upgrade:
          $ref: "#/components/schemas/QuotaUpgradeHint"
        credits:
          $ref: "#/components/schemas/ApiKeyCredits"
    QuotaRefundRequest:
      type: object
      required:
        - apiKey
        - requestId
      properties:
        apiKey:
          type: string
        requestId:
          type: string
    QuotaRefundResponse:
      type: object
      required:
        - refunded
      properties:
        refunded:
          type: boolean
        reason:
          $ref: "#/components/schemas/QuotaReason"
        limit:
          type: integer
          format: int64
        remaining:
          type: integer
          format: int64
        resetAt:
          type: string
          format: date-time
    QuotaWindowStatus:
      type: object
      required:
        - limit
        - used
        - remaining
        - resetAt
      properties:
        limit:
          type: integer
          format: int64
        used:
          type: integer
          format: int64
        remaining:
          type: integer
          format: int64
        resetAt:
          type: string
          format: date-time
    QuotaUsage:
      type: object
      required:
        - minute
        - day
      properties:
        minute:
          $ref: "#/components/schemas/QuotaWindowStatus"
        day:
          $ref: "#/components/schemas/QuotaWindowStatus"
    QuotaUpgradeHint:
      type: object
      properties:
        endpoint:
          type: string
        method:
          type: string
    QuotaStatusResponse:
      type: object
      required:
        - apiKeyId
        - plan
        - limits
        - usage
        - credits
      properties:
        apiKeyId:
          type: string
        plan:
          $ref: "#/components/schemas/Plan"
        limits:
          $ref: "#/components/schemas/ApiKeyLimits"
        usage:
          $ref: "#/components/schemas/QuotaUsage"
        credits:
          $ref: "#/components/schemas/ApiKeyCredits"
