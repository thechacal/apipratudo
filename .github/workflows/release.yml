name: release

on:
  push:
    tags:
      - "api-gateway-v*"
      - "quota-service-v*"
      - "webhook-service-v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag to release (ex: api-gateway-v0.0.2)"
        required: true
        type: string

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: api-gateway
            service: services/api-gateway
            tag_prefix: api-gateway-v
          - name: quota-service
            service: services/quota-service
            tag_prefix: quota-service-v
          - name: webhook-service
            service: services/webhook-service
            tag_prefix: webhook-service-v

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Resolve tag
        id: tag
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "tag=${{ inputs.tag }}" >> "$GITHUB_OUTPUT"
          else
            echo "tag=${GITHUB_REF_NAME}" >> "$GITHUB_OUTPUT"
          fi

      - name: Match tag to matrix entry
        id: match
        shell: bash
        run: |
          TAG="${{ steps.tag.outputs.tag }}"
          PREFIX="${{ matrix.tag_prefix }}"
          if [[ "$TAG" == ${PREFIX}* ]]; then
            echo "match=true" >> "$GITHUB_OUTPUT"
          else
            echo "match=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Derive version from tag
        if: steps.match.outputs.match == 'true'
        id: ver
        shell: bash
        run: |
          set -euo pipefail
          TAG="${{ steps.tag.outputs.tag }}"
          PREFIX="${{ matrix.tag_prefix }}"
          if [[ "$TAG" != ${PREFIX}* ]]; then
            echo "Tag $TAG does not start with prefix $PREFIX"
            exit 1
          fi
          VERSION="${TAG#${PREFIX}}"
          if [ -z "$VERSION" ]; then
            echo "Empty version parsed from tag $TAG"
            exit 1
          fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Setup Java
        if: steps.match.outputs.match == 'true'
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"
          cache: maven

      - name: Set Maven version from tag
        if: steps.match.outputs.match == 'true' && hashFiles(format('{0}/pom.xml', matrix.service)) != ''
        run: |
          mvn -B -ntp -f "${{ matrix.service }}/pom.xml" versions:set \
            -DnewVersion="${{ steps.ver.outputs.version }}" \
            -DgenerateBackupPoms=false

      - name: Validate Maven version
        if: steps.match.outputs.match == 'true' && hashFiles(format('{0}/pom.xml', matrix.service)) != ''
        shell: bash
        run: |
          set -euo pipefail
          V=$(mvn -q -ntp -f "${{ matrix.service }}/pom.xml" help:evaluate \
            -Dexpression=project.version -DforceStdout)
          if [ "$V" != "${{ steps.ver.outputs.version }}" ]; then
            echo "Version mismatch: pom=$V tag=${{ steps.ver.outputs.version }}"
            exit 1
          fi

      - name: Maven package
        if: steps.match.outputs.match == 'true' && hashFiles(format('{0}/pom.xml', matrix.service)) != ''
        run: mvn -B -ntp -DskipTests -f "${{ matrix.service }}/pom.xml" clean package

      - name: Prepare release asset
        if: steps.match.outputs.match == 'true'
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p release-assets
          JAR=$(find "${{ matrix.service }}/target" -maxdepth 1 -type f -name "*.jar" \
            ! -name "*-sources.jar" ! -name "*-javadoc.jar" ! -name "original-*.jar" | head -n 1)
          if [ -z "$JAR" ]; then
            echo "No bootable JAR found in ${{ matrix.service }}/target"
            exit 1
          fi
          cp "$JAR" "release-assets/${{ matrix.name }}-v${{ steps.ver.outputs.version }}.jar"
          if [ ! -f "release-assets/${{ matrix.name }}-v${{ steps.ver.outputs.version }}.jar" ]; then
            echo "Release asset not found: release-assets/${{ matrix.name }}-v${{ steps.ver.outputs.version }}.jar"
            exit 1
          fi

      - name: Create GitHub Release (and upload JAR)
        if: steps.match.outputs.match == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          generate_release_notes: true
          files: |
            release-assets/${{ matrix.name }}-v${{ steps.ver.outputs.version }}.jar
